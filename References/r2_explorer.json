{
  "openapi": "3.0.0",
  "info": {
    "title": "Auth SecureChat API",
    "version": "1.0.0",
    "description": "API for authentication with SecureChat using AnythingLLM"
  },
  "servers": [
    {
      "url": "/api/r2-explorer",
      "description": "API Base Path"
    }
  ],
  "components": {
    "securitySchemes": {
      "ApiKeyAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "X-Api-Key",
        "description": "API key for authorization (Priority 1)"
      },
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Bearer token for authorization (Priority 2)"
      },
      "CookieAuth": {
        "type": "apiKey",
        "in": "cookie",
        "name": "auth",
        "description": "Encrypted auth cookie for authorization (Priority 3). Provides user context for personalized operations."
      },
      "StudioCookieAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "X-Studio-Cookie",
        "description": "Encrypted auth cookie passed via X-Studio-Cookie header (Priority 3, alternative to Cookie). Provides user context for personalized operations."
      },
      "StudioCookieQueryAuth": {
        "type": "apiKey",
        "in": "query",
        "name": "X-Studio-Cookie",
        "description": "Encrypted auth cookie passed via X-Studio-Cookie query parameter (Priority 3, alternative to Cookie/Header). Provides user context for personalized operations."
      }
    }
  },
  "security": [
    {
      "ApiKeyAuth": []
    },
    {
      "BearerAuth": []
    },
    {
      "CookieAuth": []
    },
    {
      "StudioCookieAuth": []
    },
    {
      "StudioCookieQueryAuth": []
    }
  ],
  "paths": {
    "/health": {
      "/health": {
        "get": {
          "summary": "Health check endpoint",
          "description": "Returns the status of the API",
          "security": [
            {
              "ApiKeyAuth": []
            },
            {
              "BearerAuth": []
            }
          ],
          "responses": {
            "200": {
              "description": "API is running",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "status": {
                        "type": "string",
                        "example": "ok"
                      },
                      "message": {
                        "type": "string",
                        "example": "Auth SecureChat API is running"
                      },
                      "version": {
                        "type": "string",
                        "example": "1.0.0"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/auth/validate": {
      "/auth/validate": {
        "get": {
          "summary": "Validate authentication token (GET)",
          "description": "Validates the auth token parameter via query parameter",
          "security": [
            {
              "ApiKeyAuth": []
            },
            {
              "BearerAuth": []
            }
          ],
          "parameters": [
            {
              "name": "auth",
              "in": "query",
              "description": "Authentication token",
              "required": true,
              "schema": {
                "type": "string"
              }
            }
          ],
          "responses": {
            "200": {
              "description": "Authentication successful",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "firstname": {
                        "type": "string",
                        "example": "John"
                      },
                      "lastname": {
                        "type": "string",
                        "example": "Doe"
                      },
                      "email": {
                        "type": "string",
                        "example": "john.doe@example.com"
                      }
                    }
                  }
                }
              }
            },
            "401": {
              "description": "Authentication failed",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Authentication failed"
                      }
                    }
                  }
                }
              }
            },
            "500": {
              "description": "Server error",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Authentication failed"
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "post": {
          "summary": "Validate authentication token (POST)",
          "description": "Validates the auth token parameter via request body",
          "security": [
            {
              "ApiKeyAuth": []
            },
            {
              "BearerAuth": []
            }
          ],
          "requestBody": {
            "required": true,
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": [
                    "auth"
                  ],
                  "properties": {
                    "auth": {
                      "type": "string",
                      "description": "Authentication token"
                    }
                  }
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Authentication successful",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "firstname": {
                        "type": "string",
                        "example": "John"
                      },
                      "lastname": {
                        "type": "string",
                        "example": "Doe"
                      },
                      "email": {
                        "type": "string",
                        "example": "john.doe@example.com"
                      }
                    }
                  }
                }
              }
            },
            "401": {
              "description": "Authentication failed",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Authentication failed"
                      }
                    }
                  }
                }
              }
            },
            "500": {
              "description": "Server error",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Authentication failed"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/decrypt-and-save": {
      "/auth/decrypt-and-save": {
        "post": {
          "summary": "Decrypt auth token and save user data to database",
          "description": "Decrypts the provided auth token and saves the user data to the D1 database",
          "security": [
            {
              "ApiKeyAuth": []
            },
            {
              "BearerAuth": []
            }
          ],
          "requestBody": {
            "required": true,
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": [
                    "auth"
                  ],
                  "properties": {
                    "auth": {
                      "type": "string",
                      "description": "Authentication token to decrypt"
                    }
                  }
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "User data successfully saved",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "success": {
                        "type": "boolean",
                        "example": true
                      },
                      "message": {
                        "type": "string",
                        "example": "User data saved successfully"
                      },
                      "updated": {
                        "type": "boolean",
                        "example": false
                      },
                      "uid": {
                        "type": "string",
                        "example": "426bcea5-adb9-4580-a8ca-3a40fdb0ef85"
                      },
                      "userData": {
                        "type": "object",
                        "properties": {
                          "uid": {
                            "type": "string",
                            "example": "426bcea5-adb9-4580-a8ca-3a40fdb0ef85"
                          },
                          "email": {
                            "type": "string",
                            "example": "humanizeiq@eteaminc.com"
                          },
                          "firebase_uid": {
                            "type": "string",
                            "example": "wFyjGE1j8wclXayUvPbkF4c15f92"
                          },
                          "firstname": {
                            "type": "string",
                            "example": "Rajeev"
                          },
                          "lastname": {
                            "type": "string",
                            "example": "Borborah"
                          },
                          "company_name": {
                            "type": "string",
                            "nullable": true,
                            "example": null
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            "401": {
              "description": "Authentication failed",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Invalid auth parameter"
                      }
                    }
                  }
                }
              }
            },
            "500": {
              "description": "Server error",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Failed to save user data"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/upload": {
      "/upload": {
        "post": {
          "summary": "Upload file to R2 bucket",
          "description": "Uploads a file to R2 bucket with path structure /data/<uid>/Documents/<Category>/<Date>/<filename>. Requires authentication (API key, Bearer token, or auth cookie). Note: An auth cookie is required to identify the user (uid) for path construction. If using API key/Bearer token, you must also provide an auth cookie (via Cookie header, X-Studio-Cookie header, or X-Studio-Cookie query parameter).",
          "security": [
            {
              "ApiKeyAuth": []
            },
            {
              "BearerAuth": []
            },
            {
              "CookieAuth": []
            },
            {
              "StudioCookieAuth": []
            },
            {
              "StudioCookieQueryAuth": []
            }
          ],
          "parameters": [
            {
              "name": "X-Studio-Cookie",
              "in": "query",
              "required": false,
              "schema": {
                "type": "string"
              },
              "description": "Encrypted auth cookie for user identification (alternative to Cookie/Header)",
              "example": "base64-encoded-cookie-value"
            }
          ],
          "requestBody": {
            "required": true,
            "content": {
              "multipart/form-data": {
                "schema": {
                  "type": "object",
                  "required": [
                    "file"
                  ],
                  "properties": {
                    "file": {
                      "type": "string",
                      "format": "binary",
                      "description": "File to upload"
                    },
                    "metadata": {
                      "type": "string",
                      "description": "JSON string containing metadata key/value pairs. Can include \"category\" field to specify file category. If category is not provided, it will be derived from file extension.",
                      "example": "{\"category\": \"Reports\", \"project\": \"Q4-2024\", \"author\": \"John Doe\"}"
                    }
                  }
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "File uploaded successfully",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "success": {
                        "type": "boolean",
                        "example": true
                      },
                      "message": {
                        "type": "string",
                        "example": "File uploaded successfully"
                      },
                      "path": {
                        "type": "string",
                        "example": "data/426bcea5-adb9-4580-a8ca-3a40fdb0ef85/Documents/PDF/2025-10-14/document.pdf"
                      },
                      "category": {
                        "type": "string",
                        "example": "PDF"
                      },
                      "metadata": {
                        "type": "object",
                        "example": {
                          "category": "PDF",
                          "uploadDate": "2025-10-14T20:30:00.000Z",
                          "uid": "426bcea5-adb9-4580-a8ca-3a40fdb0ef85",
                          "project": "Q4-2024",
                          "author": "John Doe"
                        }
                      }
                    }
                  }
                }
              }
            },
            "400": {
              "description": "Bad request - missing file or invalid metadata",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "No file provided or invalid file format"
                      }
                    }
                  }
                }
              }
            },
            "401": {
              "description": "Unauthorized - missing or invalid auth cookie",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "No auth cookie found"
                      }
                    }
                  }
                }
              }
            },
            "500": {
              "description": "Internal server error",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Failed to upload file"
                      },
                      "details": {
                        "type": "string",
                        "example": "Error message details"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/list-files": {
      "/files": {
        "get": {
          "summary": "List user files in tree format",
          "description": "Retrieves all files for the authenticated user, optionally filtered by category. Returns files organized in a tree structure by category and date. Requires auth cookie (via Cookie header or X-Studio-Cookie header) for user identification.",
          "security": [
            {
              "ApiKeyAuth": []
            },
            {
              "BearerAuth": []
            },
            {
              "CookieAuth": []
            },
            {
              "StudioCookieAuth": []
            },
            {
              "StudioCookieQueryAuth": []
            }
          ],
          "parameters": [
            {
              "name": "category",
              "in": "query",
              "required": false,
              "schema": {
                "type": "string"
              },
              "description": "Filter files by category (e.g., \"PDF\", \"Images\", \"Documents\"). If not provided, returns all files.",
              "example": "PDF"
            },
            {
              "name": "X-Studio-Cookie",
              "in": "query",
              "required": false,
              "schema": {
                "type": "string"
              },
              "description": "Encrypted auth cookie for user identification (alternative to Cookie/Header)",
              "example": "base64-encoded-cookie-value"
            }
          ],
          "responses": {
            "200": {
              "description": "Files retrieved successfully",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "success": {
                        "type": "boolean",
                        "example": true
                      },
                      "uid": {
                        "type": "string",
                        "example": "426bcea5-adb9-4580-a8ca-3a40fdb0ef85"
                      },
                      "category": {
                        "type": "string",
                        "example": "PDF"
                      },
                      "totalFiles": {
                        "type": "integer",
                        "example": 5
                      },
                      "tree": {
                        "type": "object",
                        "description": "Tree structure organized by category and date",
                        "example": {
                          "PDF": {
                            "2025-10-14": [
                              {
                                "fileId": "ZGF0YS80MjZiY2VhNS1hZGI5LTQ1ODAtYThjYS0zYTQwZmRiMGVmODUvRG9jdW1lbnRzL1BERi8yMDI1LTEwLTE0L2RvY3VtZW50LnBkZg==",
                                "name": "document.pdf",
                                "path": "data/426bcea5-adb9-4580-a8ca-3a40fdb0ef85/Documents/PDF/2025-10-14/document.pdf",
                                "size": 1048576,
                                "uploaded": "2025-10-14T20:30:00.000Z",
                                "etag": "abc123def456",
                                "httpMetadata": {
                                  "contentType": "application/pdf"
                                },
                                "customMetadata": {
                                  "category": "PDF",
                                  "uploadDate": "2025-10-14T20:30:00.000Z",
                                  "uid": "426bcea5-adb9-4580-a8ca-3a40fdb0ef85",
                                  "fileName": "document.pdf",
                                  "fileSize": "1048576",
                                  "uploadTimestamp": "1729028400000"
                                }
                              }
                            ],
                            "2025-10-13": [
                              {
                                "fileId": "ZGF0YS80MjZiY2VhNS1hZGI5LTQ1ODAtYThjYS0zYTQwZmRiMGVmODUvRG9jdW1lbnRzL1BERi8yMDI1LTEwLTEzL3JlcG9ydC5wZGY=",
                                "name": "report.pdf",
                                "path": "data/426bcea5-adb9-4580-a8ca-3a40fdb0ef85/Documents/PDF/2025-10-13/report.pdf",
                                "size": 2097152,
                                "uploaded": "2025-10-13T15:20:00.000Z",
                                "etag": "xyz789abc012",
                                "httpMetadata": {
                                  "contentType": "application/pdf"
                                },
                                "customMetadata": {
                                  "category": "PDF",
                                  "uploadDate": "2025-10-13T15:20:00.000Z",
                                  "uid": "426bcea5-adb9-4580-a8ca-3a40fdb0ef85",
                                  "fileName": "report.pdf",
                                  "fileSize": "2097152",
                                  "uploadTimestamp": "1728842400000"
                                }
                              }
                            ]
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            "400": {
              "description": "Bad request - missing auth cookie",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Auth cookie required"
                      },
                      "message": {
                        "type": "string",
                        "example": "User identification required via auth cookie"
                      }
                    }
                  }
                }
              }
            },
            "401": {
              "description": "Unauthorized - invalid or expired auth cookie",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Invalid or expired auth cookie"
                      }
                    }
                  }
                }
              }
            },
            "500": {
              "description": "Internal server error",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Failed to list files"
                      },
                      "details": {
                        "type": "string",
                        "example": "Error message details"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/files-by-department": {
      "/files-by-department": {
        "get": {
          "summary": "List files by department",
          "description": "Retrieves all files for a specific department, organized by category. Supports optional category filtering.",
          "tags": [
            "Files"
          ],
          "security": [
            {
              "ApiKeyAuth": []
            },
            {
              "BearerAuth": []
            },
            {
              "CookieAuth": []
            },
            {
              "StudioCookieAuth": []
            },
            {
              "StudioCookieQueryAuth": []
            }
          ],
          "parameters": [
            {
              "name": "department",
              "in": "query",
              "required": true,
              "schema": {
                "type": "string"
              },
              "description": "Department name to retrieve files from"
            },
            {
              "name": "category",
              "in": "query",
              "required": false,
              "schema": {
                "type": "string"
              },
              "description": "Optional category filter (e.g., \"PDF\", \"Documents\", \"Images\")"
            },
            {
              "name": "X-Studio-Cookie",
              "in": "query",
              "required": false,
              "schema": {
                "type": "string"
              },
              "description": "Base64 encoded auth cookie (alternative to header or cookie)"
            }
          ],
          "responses": {
            "200": {
              "description": "Successfully retrieved department files",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "success": {
                        "type": "boolean",
                        "example": true
                      },
                      "company": {
                        "type": "string",
                        "example": "acme-corp"
                      },
                      "department": {
                        "type": "string",
                        "example": "engineering"
                      },
                      "category": {
                        "type": "string",
                        "example": "all"
                      },
                      "totalFiles": {
                        "type": "integer",
                        "example": 15
                      },
                      "tree": {
                        "type": "object",
                        "description": "Files organized by category",
                        "additionalProperties": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "fileId": {
                                "type": "string",
                                "description": "Base64 encoded file identifier"
                              },
                              "name": {
                                "type": "string",
                                "example": "report.pdf"
                              },
                              "path": {
                                "type": "string",
                                "example": "acme-corp/engineering/PDF/report.pdf"
                              },
                              "size": {
                                "type": "integer",
                                "example": 1024000
                              },
                              "uploaded": {
                                "type": "string",
                                "format": "date-time"
                              },
                              "etag": {
                                "type": "string"
                              },
                              "httpMetadata": {
                                "type": "object"
                              },
                              "customMetadata": {
                                "type": "object"
                              }
                            }
                          }
                        },
                        "example": {
                          "PDF": [
                            {
                              "fileId": "YWNtZS1jb3JwL2VuZ2luZWVyaW5nL1BERi9yZXBvcnQucGRm",
                              "name": "report.pdf",
                              "path": "acme-corp/engineering/PDF/report.pdf",
                              "size": 1024000,
                              "uploaded": "2024-01-15T10:30:00.000Z"
                            }
                          ],
                          "Documents": [
                            {
                              "fileId": "YWNtZS1jb3JwL2VuZ2luZWVyaW5nL0RvY3VtZW50cy9zcGVjLmRvY3g=",
                              "name": "spec.docx",
                              "path": "acme-corp/engineering/Documents/spec.docx",
                              "size": 512000,
                              "uploaded": "2024-01-16T14:20:00.000Z"
                            }
                          ]
                        }
                      }
                    }
                  }
                }
              }
            },
            "400": {
              "description": "Bad request - missing department parameter or not a company user",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "department parameter is required"
                      }
                    }
                  }
                }
              }
            },
            "401": {
              "description": "Unauthorized - invalid or missing auth cookie",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Invalid or expired auth cookie"
                      }
                    }
                  }
                }
              }
            },
            "500": {
              "description": "Server error",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Failed to list department files"
                      },
                      "details": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/files-by-metadata": {
      "/files-by-metadata": {
        "post": {
          "summary": "Get files by metadata",
          "description": "Retrieves files based on metadata filters using the same folder structure logic as upload. Supports filtering by department, category, and user-specific flag. Requires auth cookie for user identification.",
          "security": [
            {
              "ApiKeyAuth": []
            },
            {
              "BearerAuth": []
            },
            {
              "CookieAuth": []
            },
            {
              "StudioCookieAuth": []
            },
            {
              "StudioCookieQueryAuth": []
            }
          ],
          "parameters": [
            {
              "name": "X-Studio-Cookie",
              "in": "query",
              "required": false,
              "schema": {
                "type": "string"
              },
              "description": "Encrypted auth cookie for user identification (alternative to Cookie/Header)",
              "example": "base64-encoded-cookie-value"
            }
          ],
          "requestBody": {
            "required": true,
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "metadata": {
                      "type": "object",
                      "properties": {
                        "department": {
                          "type": "string",
                          "description": "Department name (defaults to \"Everyone\" if not provided)",
                          "example": "Recruiting"
                        },
                        "category": {
                          "type": "string",
                          "description": "File category (e.g., \"Resumes\", \"PDF\", \"Images\")",
                          "example": "Resumes"
                        },
                        "user-specific": {
                          "type": "boolean",
                          "description": "Whether to retrieve user-specific files (defaults to true). Files without department are always user-specific.",
                          "example": true
                        }
                      }
                    }
                  },
                  "example": {
                    "metadata": {
                      "department": "Recruiting",
                      "category": "Resumes",
                      "user-specific": true
                    }
                  }
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Files retrieved successfully",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "success": {
                        "type": "boolean",
                        "example": true
                      },
                      "totalFiles": {
                        "type": "integer",
                        "example": 3
                      },
                      "filters": {
                        "type": "object",
                        "properties": {
                          "company": {
                            "type": "string",
                            "example": "HumanizeIQ"
                          },
                          "department": {
                            "type": "string",
                            "example": "Recruiting"
                          },
                          "category": {
                            "type": "string",
                            "example": "Resumes"
                          },
                          "userSpecific": {
                            "type": "boolean",
                            "example": true
                          },
                          "uid": {
                            "type": "string",
                            "example": "7939cfe1-c6b4-4cfa-8691-ada77f011553"
                          }
                        }
                      },
                      "files": {
                        "type": "array",
                        "items": {
                          "type": "object",
                          "properties": {
                            "fileId": {
                              "type": "string",
                              "description": "Base64 encoded file path",
                              "example": "SHVtYW5pemVJUS9kZXBhcnRtZW50cy9SZWNydWl0aW5nL1Jlc3VtZXMvNzkzOWNmZTEtYzZiNC00Y2ZhLTg2OTEtYWRhNzdmMDExNTUzLzIwMjUtMTAtMjMvcmVzdW1lLnBkZg=="
                            },
                            "name": {
                              "type": "string",
                              "example": "resume.pdf"
                            },
                            "path": {
                              "type": "string",
                              "example": "HumanizeIQ/departments/Recruiting/Resumes/7939cfe1-c6b4-4cfa-8691-ada77f011553/2025-10-23/resume.pdf"
                            },
                            "size": {
                              "type": "integer",
                              "example": 524288
                            },
                            "uploaded": {
                              "type": "string",
                              "format": "date-time",
                              "example": "2025-10-23T15:30:00.000Z"
                            },
                            "etag": {
                              "type": "string",
                              "example": "abc123def456"
                            },
                            "httpMetadata": {
                              "type": "object",
                              "properties": {
                                "contentType": {
                                  "type": "string",
                                  "example": "application/pdf"
                                }
                              }
                            },
                            "customMetadata": {
                              "type": "object",
                              "properties": {
                                "category": {
                                  "type": "string",
                                  "example": "Resumes"
                                },
                                "uploadDate": {
                                  "type": "string",
                                  "example": "2025-10-23T15:30:00.000Z"
                                },
                                "uid": {
                                  "type": "string",
                                  "example": "7939cfe1-c6b4-4cfa-8691-ada77f011553"
                                },
                                "fileName": {
                                  "type": "string",
                                  "example": "resume.pdf"
                                },
                                "department": {
                                  "type": "string",
                                  "example": "Recruiting"
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            "400": {
              "description": "Bad request - missing auth cookie",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Auth cookie required"
                      },
                      "message": {
                        "type": "string",
                        "example": "User identification required via auth cookie"
                      }
                    }
                  }
                }
              }
            },
            "401": {
              "description": "Unauthorized - invalid or expired auth cookie",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Invalid or expired auth cookie"
                      }
                    }
                  }
                }
              }
            },
            "500": {
              "description": "Internal server error",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Failed to get files by metadata"
                      },
                      "details": {
                        "type": "string",
                        "example": "Error message details"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/file": {
      "/download-file": {
        "get": {
          "summary": "Get file contents by fileId or path",
          "description": "Retrieves a file from R2 storage by its encoded fileId (recommended) or full path. Returns the file contents with appropriate headers including metadata. The fileId is provided in the /files endpoint response.",
          "security": [
            {
              "ApiKeyAuth": []
            },
            {
              "BearerAuth": []
            },
            {
              "CookieAuth": []
            },
            {
              "StudioCookieAuth": []
            }
          ],
          "parameters": [
            {
              "name": "fileId",
              "in": "query",
              "required": false,
              "schema": {
                "type": "string"
              },
              "description": "Base64 encoded file ID (obtained from /files endpoint)",
              "example": "ZGF0YS80MjZiY2VhNS1hZGI5LTQ1ODAtYThjYS0zYTQwZmRiMGVmODUvRG9jdW1lbnRzL1BERi8yMDI1LTEwLTE0L2RvY3VtZW50LnBkZg=="
            },
            {
              "name": "path",
              "in": "query",
              "required": false,
              "schema": {
                "type": "string"
              },
              "description": "Full path to the file in R2 storage (alternative to fileId)",
              "example": "data/426bcea5-adb9-4580-a8ca-3a40fdb0ef85/Documents/PDF/2025-10-14/document.pdf"
            }
          ],
          "responses": {
            "200": {
              "description": "File retrieved successfully",
              "headers": {
                "Content-Type": {
                  "schema": {
                    "type": "string"
                  },
                  "description": "MIME type of the file",
                  "example": "application/pdf"
                },
                "Content-Length": {
                  "schema": {
                    "type": "string"
                  },
                  "description": "Size of the file in bytes",
                  "example": "1048576"
                },
                "ETag": {
                  "schema": {
                    "type": "string"
                  },
                  "description": "Entity tag for the file",
                  "example": "abc123def456"
                },
                "Last-Modified": {
                  "schema": {
                    "type": "string"
                  },
                  "description": "ISO 8601 timestamp of when the file was uploaded",
                  "example": "2025-10-14T20:30:00.000Z"
                },
                "X-File-Path": {
                  "schema": {
                    "type": "string"
                  },
                  "description": "Full path of the file in R2",
                  "example": "data/426bcea5-adb9-4580-a8ca-3a40fdb0ef85/Documents/PDF/2025-10-14/document.pdf"
                },
                "X-Custom-Metadata": {
                  "schema": {
                    "type": "string"
                  },
                  "description": "JSON string of custom metadata associated with the file",
                  "example": "{\"category\":\"PDF\",\"uploadDate\":\"2025-10-14T20:30:00.000Z\",\"uid\":\"426bcea5-adb9-4580-a8ca-3a40fdb0ef85\"}"
                }
              },
              "content": {
                "application/octet-stream": {
                  "schema": {
                    "type": "string",
                    "format": "binary"
                  }
                }
              }
            },
            "400": {
              "description": "Bad request - missing fileId/path parameter or invalid fileId",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Either fileId or path parameter is required"
                      }
                    }
                  }
                }
              }
            },
            "404": {
              "description": "File not found",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "File not found"
                      }
                    }
                  }
                }
              }
            },
            "500": {
              "description": "Internal server error",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Failed to get file"
                      },
                      "details": {
                        "type": "string",
                        "example": "Error message details"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/file-update": {
      "/update-file": {
        "put": {
          "summary": "Update an existing file",
          "description": "Updates an existing file in R2 storage by replacing its content. The file is identified by fileId (recommended) or path. Optionally updates metadata while preserving existing metadata.",
          "security": [
            {
              "ApiKeyAuth": []
            },
            {
              "BearerAuth": []
            },
            {
              "CookieAuth": []
            },
            {
              "StudioCookieAuth": []
            }
          ],
          "parameters": [
            {
              "name": "fileId",
              "in": "query",
              "required": false,
              "schema": {
                "type": "string"
              },
              "description": "Base64 encoded file ID (obtained from /files endpoint)",
              "example": "ZGF0YS80MjZiY2VhNS1hZGI5LTQ1ODAtYThjYS0zYTQwZmRiMGVmODUvRG9jdW1lbnRzL1BERi8yMDI1LTEwLTE0L2RvY3VtZW50LnBkZg=="
            },
            {
              "name": "path",
              "in": "query",
              "required": false,
              "schema": {
                "type": "string"
              },
              "description": "Full path to the file in R2 storage (alternative to fileId)",
              "example": "data/426bcea5-adb9-4580-a8ca-3a40fdb0ef85/Documents/PDF/2025-10-14/document.pdf"
            }
          ],
          "requestBody": {
            "required": true,
            "content": {
              "multipart/form-data": {
                "schema": {
                  "type": "object",
                  "required": [
                    "file"
                  ],
                  "properties": {
                    "file": {
                      "type": "string",
                      "format": "binary",
                      "description": "The new file content to replace the existing file"
                    },
                    "metadata": {
                      "type": "string",
                      "description": "Optional JSON string of metadata to update (merged with existing metadata)",
                      "example": "{\"version\":\"2.0\",\"updatedBy\":\"user@example.com\"}"
                    }
                  }
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "File updated successfully",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "message": {
                        "type": "string",
                        "example": "File updated successfully"
                      },
                      "path": {
                        "type": "string",
                        "example": "data/426bcea5-adb9-4580-a8ca-3a40fdb0ef85/Documents/PDF/2025-10-14/document.pdf"
                      },
                      "size": {
                        "type": "integer",
                        "example": 2097152
                      },
                      "contentType": {
                        "type": "string",
                        "example": "application/pdf"
                      },
                      "metadata": {
                        "type": "object",
                        "example": {
                          "category": "PDF",
                          "version": "2.0",
                          "updatedBy": "user@example.com",
                          "lastModified": "2025-10-15T20:30:00.000Z"
                        }
                      }
                    }
                  }
                }
              }
            },
            "400": {
              "description": "Bad request - missing parameters or invalid data",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "File is required"
                      }
                    }
                  }
                }
              }
            },
            "404": {
              "description": "File not found",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "File not found"
                      },
                      "path": {
                        "type": "string",
                        "example": "data/426bcea5-adb9-4580-a8ca-3a40fdb0ef85/Documents/PDF/2025-10-14/document.pdf"
                      }
                    }
                  }
                }
              }
            },
            "500": {
              "description": "Internal server error",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Failed to update file"
                      },
                      "details": {
                        "type": "string",
                        "example": "Error message details"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/file-delete": {
      "/delete-file": {
        "delete": {
          "tags": [
            "Files"
          ],
          "summary": "Delete a file",
          "description": "Delete a file from R2 storage by fileId. Requires authentication.",
          "parameters": [
            {
              "name": "fileId",
              "in": "query",
              "schema": {
                "type": "string"
              },
              "description": "The encoded file ID (base64 of the R2 key)"
            }
          ],
          "responses": {
            "200": {
              "description": "File deleted successfully",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "success": {
                        "type": "boolean",
                        "example": true
                      },
                      "message": {
                        "type": "string",
                        "example": "File deleted successfully"
                      },
                      "path": {
                        "type": "string",
                        "example": "consumer/data/uid/Documents/test.txt"
                      }
                    }
                  }
                }
              }
            },
            "400": {
              "description": "Bad Request - Missing or invalid parameters",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "fileId parameter is required"
                      }
                    }
                  }
                }
              }
            },
            "401": {
              "description": "Unauthorized - Invalid or missing auth cookie"
            },
            "404": {
              "description": "Not Found - File does not exist",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "File not found"
                      },
                      "path": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            },
            "500": {
              "description": "Internal Server Error"
            }
          }
        }
      }
    },
    "/file-patch": {
      "/file/{fileId}": {
        "patch": {
          "tags": [
            "File Management"
          ],
          "summary": "Update File Knowledge Status",
          "description": "Updates a file's metadata with the knowledgefile tag and triggers the knowledge processor queue.",
          "parameters": [
            {
              "name": "fileId",
              "in": "path",
              "required": true,
              "description": "Encoded file ID (base64 of path)",
              "schema": {
                "type": "string"
              }
            }
          ],
          "requestBody": {
            "required": true,
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": [
                    "knowledgefile"
                  ],
                  "properties": {
                    "knowledgefile": {
                      "type": "boolean",
                      "description": "Set to true to add to knowledge base, false to remove"
                    }
                  }
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Metadata updated and message sent to queue",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "success": {
                        "type": "boolean"
                      },
                      "message": {
                        "type": "string"
                      },
                      "path": {
                        "type": "string"
                      },
                      "metadata": {
                        "type": "object"
                      }
                    }
                  }
                }
              }
            },
            "400": {
              "description": "Bad Request - Missing knowledgefile or invalid fileId"
            },
            "401": {
              "description": "Unauthorized"
            },
            "404": {
              "description": "File not found"
            },
            "500": {
              "description": "Internal Server Error"
            }
          }
        }
      }
    },
    "/object": {
      "/object": {
        "get": {
          "tags": [
            "Files"
          ],
          "summary": "Get file content (Inline)",
          "description": "Get the content of a file for inline display (e.g., in a browser). Returns the file with Content-Disposition: inline.",
          "parameters": [
            {
              "name": "fileId",
              "in": "query",
              "schema": {
                "type": "string"
              },
              "description": "The encoded file ID (base64 of the R2 key)",
              "required": true
            }
          ],
          "responses": {
            "200": {
              "description": "File content",
              "content": {
                "*/*": {
                  "schema": {
                    "type": "string",
                    "format": "binary"
                  }
                }
              }
            },
            "400": {
              "description": "Bad Request - Missing or invalid parameters"
            },
            "404": {
              "description": "Not Found - File does not exist"
            },
            "500": {
              "description": "Internal Server Error"
            }
          }
        }
      }
    },
    "/ai-search/reindex": {
      "/ai-search/reindex": {
        "post": {
          "tags": [
            "Vector Search"
          ],
          "summary": "Trigger AI Search Reindex",
          "description": "Triggers a manual sync/reindex of the Cloudflare AI Search index. This forces AI Search to scan the R2 data source for new or modified files and update the Vectorize index. Note: There is a cooldown period of 30 seconds between sync requests.",
          "responses": {
            "200": {
              "description": "Reindex triggered successfully",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "success": {
                        "type": "boolean"
                      },
                      "message": {
                        "type": "string"
                      },
                      "result": {
                        "type": "object"
                      }
                    }
                  }
                }
              }
            },
            "401": {
              "description": "Unauthorized - Authentication required"
            },
            "429": {
              "description": "Too Many Requests - Cooldown period not elapsed"
            },
            "500": {
              "description": "Internal Server Error - Configuration missing or API failure"
            }
          }
        }
      }
    },
    "/knowledge": {
      "/knowledge": {
        "get": {
          "tags": [
            "Knowledge Management"
          ],
          "summary": "Get Knowledge Document",
          "description": "Retrieves a knowledge document by fileId",
          "parameters": [
            {
              "name": "fileId",
              "in": "query",
              "required": true,
              "schema": {
                "type": "string"
              },
              "description": "Base64 encoded file ID"
            }
          ],
          "responses": {
            "200": {
              "description": "Knowledge document retrieved successfully",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "success": {
                        "type": "boolean"
                      },
                      "fileId": {
                        "type": "string"
                      },
                      "path": {
                        "type": "string"
                      },
                      "metadata": {
                        "type": "object"
                      },
                      "content": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            },
            "400": {
              "description": "Bad Request - Missing fileId"
            },
            "401": {
              "description": "Unauthorized"
            },
            "404": {
              "description": "Knowledge document not found"
            },
            "500": {
              "description": "Internal Server Error"
            }
          }
        },
        "put": {
          "tags": [
            "Knowledge Management"
          ],
          "summary": "Create Knowledge Document",
          "description": "Stores a knowledge document as JSON with embedded metadata. Path structure: knowledge/<department>/<entity_name>.json. Department defaults to AllDepartments if kb_department not provided. Filename is derived from kb_entity_name with special characters and spaces replaced by underscore. Filename cannot be changed once created.",
          "requestBody": {
            "required": true,
            "content": {
              "multipart/form-data": {
                "schema": {
                  "type": "object",
                  "required": [
                    "file",
                    "metadata"
                  ],
                  "properties": {
                    "file": {
                      "type": "string",
                      "format": "binary",
                      "description": "The file containing knowledge content"
                    },
                    "metadata": {
                      "type": "string",
                      "description": "JSON string containing mandatory kb_* fields",
                      "example": "{\"kb_entity_type\":\"Company\",\"kb_entity_name\":\"Acme Corporation\",\"kb_department\":\"Engineering\",\"kb_version\":\"1\",\"kb_updated_utc\":\"1970-01-01T00:00:00.000Z\",\"kb_owner_type\":\"Company\",\"workspace_id\":\"ws_12345\",\"kb_sources\":\"doc_1,doc_2\"}"
                    }
                  }
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Document uploaded successfully",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "success": {
                        "type": "boolean"
                      },
                      "fileId": {
                        "type": "string"
                      },
                      "path": {
                        "type": "string"
                      },
                      "category": {
                        "type": "string"
                      },
                      "metadata": {
                        "type": "object"
                      }
                    }
                  }
                }
              }
            },
            "400": {
              "description": "Bad Request - Missing mandatory metadata or invalid file"
            },
            "401": {
              "description": "Unauthorized"
            },
            "500": {
              "description": "Internal Server Error"
            }
          }
        },
        "patch": {
          "tags": [
            "Knowledge Management"
          ],
          "summary": "Update Knowledge Document",
          "description": "Updates an existing knowledge document by fileId. File and metadata are optional.",
          "parameters": [
            {
              "name": "fileId",
              "in": "query",
              "required": true,
              "schema": {
                "type": "string"
              },
              "description": "Base64 encoded file ID"
            }
          ],
          "requestBody": {
            "required": false,
            "content": {
              "multipart/form-data": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "file": {
                      "type": "string",
                      "format": "binary",
                      "description": "Optional new file content"
                    },
                    "metadata": {
                      "type": "string",
                      "description": "Optional JSON string containing metadata to update"
                    }
                  }
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Document updated successfully",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "success": {
                        "type": "boolean"
                      },
                      "message": {
                        "type": "string"
                      },
                      "fileId": {
                        "type": "string"
                      },
                      "path": {
                        "type": "string"
                      },
                      "category": {
                        "type": "string"
                      },
                      "metadata": {
                        "type": "object"
                      }
                    }
                  }
                }
              }
            },
            "400": {
              "description": "Bad Request - Missing fileId"
            },
            "401": {
              "description": "Unauthorized"
            },
            "404": {
              "description": "Knowledge document not found"
            },
            "500": {
              "description": "Internal Server Error"
            }
          }
        },
        "delete": {
          "tags": [
            "Knowledge Management"
          ],
          "summary": "Delete Knowledge Document",
          "description": "Deletes a knowledge document by fileId",
          "parameters": [
            {
              "name": "fileId",
              "in": "query",
              "required": true,
              "schema": {
                "type": "string"
              },
              "description": "Base64 encoded file ID"
            }
          ],
          "responses": {
            "200": {
              "description": "Document deleted successfully",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "success": {
                        "type": "boolean"
                      },
                      "fileId": {
                        "type": "string"
                      },
                      "path": {
                        "type": "string"
                      },
                      "message": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            },
            "400": {
              "description": "Bad Request - Missing fileId"
            },
            "401": {
              "description": "Unauthorized"
            },
            "404": {
              "description": "Knowledge document not found"
            },
            "500": {
              "description": "Internal Server Error"
            }
          }
        }
      },
      "/knowledge/list": {
        "get": {
          "tags": [
            "Knowledge Management"
          ],
          "summary": "List Knowledge Documents",
          "description": "Lists all knowledge documents with metadata. Optionally filter by entity type.",
          "parameters": [
            {
              "name": "kb_owner_type",
              "in": "query",
              "required": false,
              "schema": {
                "type": "string",
                "default": "User"
              },
              "description": "Owner type (Company or User)"
            },
            {
              "name": "kb_entity_type",
              "in": "query",
              "required": false,
              "schema": {
                "type": "string"
              },
              "description": "Optional filter by entity type"
            }
          ],
          "responses": {
            "200": {
              "description": "Knowledge documents listed successfully",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "success": {
                        "type": "boolean"
                      },
                      "prefix": {
                        "type": "string"
                      },
                      "count": {
                        "type": "integer"
                      },
                      "documents": {
                        "type": "array",
                        "items": {
                          "type": "object",
                          "properties": {
                            "fileId": {
                              "type": "string"
                            },
                            "path": {
                              "type": "string"
                            },
                            "size": {
                              "type": "integer"
                            },
                            "uploaded": {
                              "type": "string"
                            },
                            "etag": {
                              "type": "string"
                            },
                            "metadata": {
                              "type": "object"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            "401": {
              "description": "Unauthorized"
            },
            "500": {
              "description": "Internal Server Error"
            }
          }
        }
      }
    },
    "/upload-report": {
      "/upload-generic": {
        "post": {
          "summary": "Generic system upload to R2 (no user auth cookie)",
          "description": "Uploads a file to the R2 bucket using the same path logic as the regular /upload endpoint. Company, department, and user-specific behavior are derived from metadata instead of a user auth cookie. The request must be multipart/form-data with a file field and an optional metadata JSON string. Use the metadata fields \"company\"/\"company_name\"/\"companyName\" to control the company folder, \"department\"/\"Department\" for department, and \"user-specific\" (true/false) for user-specific vs shared paths.",
          "tags": [
            "Generic"
          ],
          "security": [
            {
              "ApiKeyAuth": []
            },
            {
              "BearerAuth": []
            }
          ],
          "requestBody": {
            "required": true,
            "content": {
              "multipart/form-data": {
                "schema": {
                  "type": "object",
                  "required": [
                    "file"
                  ],
                  "properties": {
                    "file": {
                      "type": "string",
                      "format": "binary",
                      "description": "File to upload"
                    },
                    "metadata": {
                      "type": "string",
                      "description": "JSON string containing metadata key/value pairs. Should include company/department/user-specific to control path, and may include call_id, candidate_id, candidate_email, job_id, job_ref, etc.",
                      "example": "{\"uid\": \"system-generic\", \"company\": \"eTeam Inc\", \"Department\": \"Recruiting\", \"user-specific\": false, \"category\": \"AIInterviewReports\", \"call_id\": \"call_19913980616786_1763719874597\", \"candidate_id\": \"12345\", \"candidate_email\": \"candidate@example.com\", \"job_id\": \"26045639\", \"job_ref\": \"23-01265\"}"
                    }
                  }
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "File uploaded successfully",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "success": {
                        "type": "boolean",
                        "example": true
                      },
                      "message": {
                        "type": "string",
                        "example": "File uploaded successfully"
                      },
                      "path": {
                        "type": "string",
                        "example": "eTeam Inc/departments/Recruiting/AIInterviewReports/2025-11-21/ai-summary-19745031817153-1761908089711.md"
                      },
                      "category": {
                        "type": "string",
                        "example": "AIInterviewReports"
                      },
                      "metadata": {
                        "type": "object",
                        "description": "Final metadata stored with the object in R2"
                      },
                      "user": {
                        "type": "object",
                        "properties": {
                          "uid": {
                            "type": "string",
                            "example": "system-generic"
                          },
                          "email": {
                            "type": "string",
                            "example": "candidate@example.com"
                          }
                        }
                      },
                      "savedIn": {
                        "type": "string",
                        "example": "company"
                      }
                    }
                  }
                }
              }
            },
            "400": {
              "description": "Bad request - missing file or invalid metadata JSON",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Invalid metadata format. Must be valid JSON."
                      },
                      "details": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            },
            "500": {
              "description": "Internal server error",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "error": {
                        "type": "string",
                        "example": "Failed to upload file"
                      },
                      "details": {
                        "type": "string",
                        "example": "Error message details"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/save_user_doc": {
      "post": {
        "tags": [
          "R2 Explorer"
        ],
        "summary": "Save a user document with strict scoping",
        "description": "Saves a file to R2 with the path structure: {company}/{uid}/{category}/{fileName}. Search will be scoped to this folder.",
        "operationId": "saveUserDoc",
        "requestBody": {
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "properties": {
                  "file": {
                    "type": "string",
                    "format": "binary",
                    "description": "The file to upload"
                  },
                  "category": {
                    "type": "string",
                    "description": "Category for the file (e.g., Finance, Engineering). Defaults to General.",
                    "default": "General"
                  },
                  "agent": {
                    "type": "string",
                    "description": "Agent identifier for processing the file. Defaults to empty string. When provided, agent_status is automatically set to \"New\".",
                    "default": ""
                  }
                },
                "required": [
                  "file"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "File saved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "message": {
                      "type": "string"
                    },
                    "path": {
                      "type": "string"
                    },
                    "category": {
                      "type": "string"
                    },
                    "metadata": {
                      "type": "object"
                    },
                    "user": {
                      "type": "object",
                      "properties": {
                        "uid": {
                          "type": "string"
                        },
                        "email": {
                          "type": "string"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid request",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Server error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    },
                    "details": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "ApiKeyAuth": []
          },
          {
            "BearerAuth": []
          },
          {
            "CookieAuth": []
          },
          {
            "StudioCookieAuth": []
          }
        ]
      }
    },
    "/get_user_doc": {
      "get": {
        "tags": [
          "R2 Explorer"
        ],
        "summary": "Get user documents within a specific category",
        "description": "Lists all documents uploaded by the user in the specified category (e.g., {company}/{uid}/{category}/).",
        "operationId": "getUserDoc",
        "parameters": [
          {
            "name": "category",
            "in": "query",
            "description": "Category to list documents from (e.g., Finance, Engineering). Defaults to General.",
            "required": false,
            "schema": {
              "type": "string",
              "default": "General"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "List of user documents",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "count": {
                      "type": "integer"
                    },
                    "prefix": {
                      "type": "string"
                    },
                    "category": {
                      "type": "string"
                    },
                    "files": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "fileId": {
                            "type": "string"
                          },
                          "fileName": {
                            "type": "string"
                          },
                          "path": {
                            "type": "string"
                          },
                          "size": {
                            "type": "integer"
                          },
                          "uploadedAt": {
                            "type": "string",
                            "format": "date-time"
                          },
                          "contentType": {
                            "type": "string"
                          },
                          "metadata": {
                            "type": "object"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Server error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    },
                    "details": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "ApiKeyAuth": []
          },
          {
            "BearerAuth": []
          },
          {
            "CookieAuth": []
          },
          {
            "StudioCookieAuth": []
          }
        ]
      }
    },
    "/list_user_files_by_metadata": {
      "post": {
        "tags": [
          "R2 Explorer"
        ],
        "summary": "List user documents by metadata",
        "description": "Retrieves user-scoped documents based on metadata filters (e.g., category). Search is restricted to the user's own folder structure.",
        "operationId": "listUserDocsByMetadata",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "metadata": {
                    "type": "object",
                    "properties": {
                      "category": {
                        "type": "string",
                        "description": "File category (e.g., \"Finance\", \"Engineering\")",
                        "example": "Finance"
                      }
                    }
                  }
                },
                "example": {
                  "metadata": {
                    "category": "Finance"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "List of user documents retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "totalFiles": {
                      "type": "integer"
                    },
                    "filters": {
                      "type": "object",
                      "properties": {
                        "company": {
                          "type": "string"
                        },
                        "category": {
                          "type": "string"
                        },
                        "uid": {
                          "type": "string"
                        },
                        "metadata": {
                          "type": "object"
                        }
                      }
                    },
                    "files": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "fileId": {
                            "type": "string"
                          },
                          "fileName": {
                            "type": "string"
                          },
                          "name": {
                            "type": "string"
                          },
                          "path": {
                            "type": "string"
                          },
                          "size": {
                            "type": "integer"
                          },
                          "uploadedAt": {
                            "type": "string",
                            "format": "date-time"
                          },
                          "uploaded": {
                            "type": "string"
                          },
                          "contentType": {
                            "type": "string"
                          },
                          "metadata": {
                            "type": "object"
                          },
                          "customMetadata": {
                            "type": "object"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Server error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    },
                    "details": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "ApiKeyAuth": []
          },
          {
            "BearerAuth": []
          },
          {
            "CookieAuth": []
          },
          {
            "StudioCookieAuth": []
          }
        ]
      }
    },
    "/get_user_file": {
      "get": {
        "tags": [
          "R2 Explorer"
        ],
        "summary": "Get user file contents",
        "description": "Retrieves a user-scoped document from R2 by its fileId or path. Search is restricted to the user's own folder structure.",
        "operationId": "getUserFile",
        "parameters": [
          {
            "name": "fileId",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Base64 encoded file ID"
          },
          {
            "name": "path",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Full path to the file in R2"
          }
        ],
        "responses": {
          "200": {
            "description": "File retrieved successfully",
            "content": {
              "application/octet-stream": {
                "schema": {
                  "type": "string",
                  "format": "binary"
                }
              }
            }
          },
          "403": {
            "description": "Access denied",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "File not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Server error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    },
                    "details": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "ApiKeyAuth": []
          },
          {
            "BearerAuth": []
          },
          {
            "CookieAuth": []
          },
          {
            "StudioCookieAuth": []
          }
        ]
      }
    },
    "/update_user_file": {
      "put": {
        "tags": [
          "R2 Explorer"
        ],
        "summary": "Update user file contents",
        "description": "Updates a user-scoped document in R2 by replacing its content. With X-API-Key: can update any file. With auth cookie: restricted to the user's own folder structure.",
        "operationId": "updateUserFile",
        "parameters": [
          {
            "name": "fileId",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Base64 encoded file ID"
          },
          {
            "name": "path",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Full path to the file in R2"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "required": [
                  "file"
                ],
                "properties": {
                  "file": {
                    "type": "string",
                    "format": "binary",
                    "description": "New file content"
                  },
                  "metadata": {
                    "type": "string",
                    "description": "Optional JSON string of metadata"
                  },
                  "agent": {
                    "type": "string",
                    "description": "Optional agent identifier"
                  },
                  "agent_status": {
                    "type": "string",
                    "description": "Optional agent status"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "File updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string"
                    },
                    "path": {
                      "type": "string"
                    },
                    "size": {
                      "type": "integer"
                    },
                    "contentType": {
                      "type": "string"
                    },
                    "metadata": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          },
          "403": {
            "description": "Access denied",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "File not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    },
                    "path": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Server error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    },
                    "details": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "apiKeyAuth": []
          },
          {
            "cookieAuth": []
          }
        ]
      }
    },
    "/delete_user_file": {
      "delete": {
        "tags": [
          "R2 Explorer"
        ],
        "summary": "Delete user file",
        "description": "Deletes a user-scoped document from R2 by its fileId or path. Restricted to the user's own folder structure.",
        "operationId": "deleteUserFile",
        "parameters": [
          {
            "name": "fileId",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Base64 encoded file ID"
          },
          {
            "name": "path",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Full path to the file in R2"
          }
        ],
        "responses": {
          "200": {
            "description": "File deleted successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "message": {
                      "type": "string"
                    },
                    "path": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "File not found"
          },
          "500": {
            "description": "Server error"
          }
        },
        "security": [
          {
            "ApiKeyAuth": []
          },
          {
            "BearerAuth": []
          },
          {
            "CookieAuth": []
          },
          {
            "StudioCookieAuth": []
          }
        ]
      }
    },
    "/update_user_knowledge": {
      "post": {
        "tags": [
          "R2 Explorer"
        ],
        "summary": "Update user knowledge document",
        "description": "Stores or updates a knowledge document restricted to the user scope. Requires mandatory kb_* metadata fields.",
        "operationId": "updateUserKnowledge",
        "requestBody": {
          "required": true,
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "required": [
                  "file",
                  "metadata"
                ],
                "properties": {
                  "file": {
                    "type": "string",
                    "format": "binary",
                    "description": "The .md file containing knowledge content"
                  },
                  "metadata": {
                    "type": "string",
                    "description": "JSON string containing kb_* fields"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Knowledge document updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "path": {
                      "type": "string"
                    },
                    "category": {
                      "type": "string"
                    },
                    "metadata": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request"
          },
          "500": {
            "description": "Server error"
          }
        },
        "security": [
          {
            "ApiKeyAuth": []
          },
          {
            "BearerAuth": []
          },
          {
            "CookieAuth": []
          },
          {
            "StudioCookieAuth": []
          }
        ]
      }
    },
    "/update_user_file_meta": {
      "patch": {
        "tags": [
          "R2 Explorer"
        ],
        "summary": "Update user file metadata",
        "description": "Updates metadata for a user-scoped document. With X-API-Key: can update any file. With auth cookie: restricted to the user's own folder structure.",
        "operationId": "updateUserFileMeta",
        "parameters": [
          {
            "name": "fileId",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Base64 encoded file ID"
          },
          {
            "name": "path",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Full path to the file in R2"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "metadata": {
                    "type": "object",
                    "description": "Metadata to merge into existing metadata"
                  },
                  "agent": {
                    "type": "string",
                    "description": "Optional agent identifier to update in file_registry"
                  },
                  "agent_status": {
                    "type": "string",
                    "description": "Optional agent status to update in file_registry"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "File metadata updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "path": {
                      "type": "string"
                    },
                    "metadata": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "File not found"
          },
          "500": {
            "description": "Server error"
          }
        },
        "security": [
          {
            "apiKeyAuth": []
          },
          {
            "cookieAuth": []
          }
        ]
      }
    },
    "/update_file_agent": {
      "patch": {
        "tags": [
          "R2 Explorer"
        ],
        "summary": "Update file agent and agent_status",
        "description": "Updates the agent and/or agent_status fields in the file_registry table. With X-API-Key: can update any file. With auth cookie: requires authentication.",
        "operationId": "updateFileAgent",
        "parameters": [
          {
            "name": "fileId",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Base64 encoded file ID"
          },
          {
            "name": "path",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Full path to the file in R2 (will be encoded to fileId)"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "agent": {
                    "type": "string",
                    "description": "Agent identifier"
                  },
                  "agent_status": {
                    "type": "string",
                    "description": "Agent status (e.g., New, Processing, Completed, Failed)"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "File agent updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "message": {
                      "type": "string"
                    },
                    "fileid": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - missing required parameters",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - authentication required",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Server error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    },
                    "details": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "apiKeyAuth": []
          },
          {
            "cookieAuth": []
          }
        ]
      }
    },
    "/list_files_by_agent": {
      "get": {
        "tags": [
          "R2 Explorer"
        ],
        "summary": "List files by agent and agent_status",
        "description": "Retrieves files from file_registry based on agent field and optionally filters by agent_status. Authentication determines filtering: X-API-Key returns all files, auth cookie returns only user's files.",
        "operationId": "listFilesByAgent",
        "parameters": [
          {
            "name": "agent",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The agent value to filter files by"
          },
          {
            "name": "agent_status",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "The agent status to filter by. If not provided, returns files with any status"
          },
          {
            "name": "x-d1-bookmark",
            "in": "header",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "D1 session bookmark for read replication continuity"
          }
        ],
        "responses": {
          "200": {
            "description": "Files retrieved successfully",
            "headers": {
              "x-d1-bookmark": {
                "schema": {
                  "type": "string"
                },
                "description": "D1 session bookmark for maintaining read consistency"
              }
            },
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "agent": {
                      "type": "string",
                      "description": "The agent value queried"
                    },
                    "agent_status": {
                      "type": "string",
                      "description": "The agent_status queried or \"all\""
                    },
                    "filtered_by_user": {
                      "type": "boolean",
                      "description": "Whether results are filtered by user (true for auth cookie, false for X-API-Key)"
                    },
                    "count": {
                      "type": "integer",
                      "description": "Number of files returned"
                    },
                    "files": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "integer"
                          },
                          "fileid": {
                            "type": "string"
                          },
                          "filename": {
                            "type": "string"
                          },
                          "folder": {
                            "type": "string"
                          },
                          "category": {
                            "type": "string"
                          },
                          "userid": {
                            "type": "string"
                          },
                          "filepath": {
                            "type": "string"
                          },
                          "metadata": {
                            "type": "object"
                          },
                          "agent": {
                            "type": "string"
                          },
                          "agent_status": {
                            "type": "string"
                          },
                          "created_by": {
                            "type": "string"
                          },
                          "updated_by": {
                            "type": "string"
                          },
                          "created_at": {
                            "type": "string",
                            "format": "date-time"
                          },
                          "updated_at": {
                            "type": "string",
                            "format": "date-time"
                          }
                        }
                      }
                    }
                  }
                },
                "examples": {
                  "with-api-key": {
                    "summary": "Response with X-API-Key (all files)",
                    "value": {
                      "success": true,
                      "agent": "processing-agent",
                      "agent_status": "completed",
                      "filtered_by_user": false,
                      "count": 5,
                      "files": [
                        {
                          "id": 1,
                          "fileid": "abc123",
                          "filename": "document.pdf",
                          "folder": "company/Users/user123/Documents",
                          "category": "PDF",
                          "userid": "user123",
                          "filepath": "company/Users/user123/Documents/document.pdf",
                          "metadata": {
                            "uploadDate": "2026-02-15T21:00:00.000Z"
                          },
                          "agent": "processing-agent",
                          "agent_status": "completed",
                          "created_by": "user@example.com",
                          "updated_by": "user@example.com",
                          "created_at": "2026-02-15T21:00:00.000Z",
                          "updated_at": "2026-02-15T21:30:00.000Z"
                        }
                      ]
                    }
                  },
                  "with-auth-cookie": {
                    "summary": "Response with auth cookie (user files only)",
                    "value": {
                      "success": true,
                      "agent": "processing-agent",
                      "agent_status": "pending",
                      "filtered_by_user": true,
                      "count": 2,
                      "files": []
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - missing required parameter",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Agent parameter is required"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - authentication required",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Authentication required"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Server error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string"
                    },
                    "details": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "security": [
          {
            "apiKeyAuth": []
          },
          {
            "cookieAuth": []
          }
        ]
      }
    },
    "/knowledge_processor/knowledge": {
      "put": {
        "tags": [
          "Knowledge Processor"
        ],
        "summary": "Create knowledge vectors from R2 document",
        "description": "Create vector embeddings in Turbopuffer from a document stored in R2. Documents are stored in R2, vectors in Turbopuffer.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "r2FileId",
                  "metadata"
                ],
                "properties": {
                  "r2FileId": {
                    "type": "string",
                    "description": "The R2 file ID of the document to vectorize"
                  },
                  "metadata": {
                    "type": "object",
                    "description": "Knowledge metadata",
                    "required": [
                      "kb_entity_type",
                      "kb_entity_name",
                      "kb_version",
                      "kb_updated_utc",
                      "kb_owner_type",
                      "workspace_id"
                    ],
                    "properties": {
                      "kb_entity_type": {
                        "type": "string",
                        "example": "Workspace"
                      },
                      "kb_entity_name": {
                        "type": "string",
                        "example": "My Workspace"
                      },
                      "kb_version": {
                        "type": "string",
                        "example": "1.0"
                      },
                      "kb_updated_utc": {
                        "type": "string",
                        "example": "2025-01-01T00:00:00Z"
                      },
                      "kb_owner_type": {
                        "type": "string",
                        "enum": [
                          "User",
                          "Company"
                        ],
                        "example": "User"
                      },
                      "kb_department": {
                        "type": "string",
                        "example": "Engineering"
                      },
                      "workspace_id": {
                        "type": "string",
                        "example": "ws-123"
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Knowledge vectors created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "message": {
                      "type": "string"
                    },
                    "fileId": {
                      "type": "string",
                      "description": "Turbopuffer document ID"
                    },
                    "documentId": {
                      "type": "string"
                    },
                    "r2FileId": {
                      "type": "string",
                      "description": "R2 file ID"
                    },
                    "r2Path": {
                      "type": "string",
                      "description": "R2 storage path"
                    },
                    "chunks": {
                      "type": "integer",
                      "description": "Number of chunks created"
                    },
                    "category": {
                      "type": "string"
                    },
                    "metadata": {
                      "type": "object"
                    },
                    "user": {
                      "type": "object",
                      "properties": {
                        "uid": {
                          "type": "string"
                        },
                        "email": {
                          "type": "string"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - missing r2FileId or metadata"
          },
          "401": {
            "description": "Unauthorized - invalid auth cookie"
          },
          "500": {
            "description": "Server error"
          }
        }
      },
      "get": {
        "tags": [
          "Knowledge Processor"
        ],
        "summary": "Get knowledge document from Turbopuffer",
        "description": "Retrieve a knowledge document by document ID from Turbopuffer.",
        "parameters": [
          {
            "name": "fileId",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The file ID to retrieve"
          }
        ],
        "responses": {
          "200": {
            "description": "Knowledge document retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "fileId": {
                      "type": "string"
                    },
                    "content": {
                      "type": "string"
                    },
                    "metadata": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - missing fileId"
          },
          "404": {
            "description": "Document not found"
          },
          "500": {
            "description": "Server error"
          }
        }
      },
      "patch": {
        "tags": [
          "Knowledge Processor"
        ],
        "summary": "Update knowledge document in Turbopuffer",
        "description": "Update knowledge vectors in Turbopuffer. If r2FileId is provided, fetches updated content from R2 and re-vectorizes. Otherwise, updates metadata only.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "fileId"
                ],
                "properties": {
                  "fileId": {
                    "type": "string",
                    "description": "Turbopuffer document ID to update"
                  },
                  "r2FileId": {
                    "type": "string",
                    "description": "Optional R2 file ID - if provided, fetches updated content and re-vectorizes"
                  },
                  "metadata": {
                    "type": "object",
                    "description": "Optional metadata to update"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Knowledge vectors updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "message": {
                      "type": "string"
                    },
                    "fileId": {
                      "type": "string"
                    },
                    "documentId": {
                      "type": "string"
                    },
                    "r2FileId": {
                      "type": "string"
                    },
                    "r2Path": {
                      "type": "string"
                    },
                    "chunks": {
                      "type": "integer"
                    },
                    "chunks_updated": {
                      "type": "integer"
                    },
                    "metadata": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - missing fileId"
          },
          "404": {
            "description": "Document not found"
          },
          "500": {
            "description": "Server error"
          }
        }
      },
      "delete": {
        "tags": [
          "Knowledge Processor"
        ],
        "summary": "Delete knowledge document from Turbopuffer",
        "description": "Delete a knowledge document by file ID from Turbopuffer.",
        "parameters": [
          {
            "name": "fileId",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The file ID to delete"
          }
        ],
        "responses": {
          "200": {
            "description": "Knowledge document deleted successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "message": {
                      "type": "string"
                    },
                    "fileId": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - missing fileId"
          },
          "404": {
            "description": "Document not found"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/knowledge_processor/knowledge/search": {
      "post": {
        "tags": [
          "Knowledge Processor"
        ],
        "summary": "Search knowledge documents in Turbopuffer",
        "description": "Search knowledge documents using BM25 full-text search or vector ANN search. Use search_type to select mode.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "query"
                ],
                "properties": {
                  "query": {
                    "type": "string",
                    "description": "Search query text"
                  },
                  "knowledgebase_id": {
                    "type": "string",
                    "description": "Knowledge base ID (namespace) to search in. If provided, overrides other filtering."
                  },
                  "search_type": {
                    "type": "string",
                    "enum": [
                      "bm25",
                      "vector"
                    ],
                    "default": "bm25",
                    "description": "Search type: bm25 for full-text search, vector for ANN similarity search (auto-generates embedding from query)"
                  },
                  "kb_owner_type": {
                    "type": "string",
                    "enum": [
                      "User",
                      "Company"
                    ],
                    "default": "User",
                    "description": "Filter by owner type"
                  },
                  "limit": {
                    "type": "integer",
                    "default": 10,
                    "description": "Maximum number of results"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Search results",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "query": {
                      "type": "string"
                    },
                    "count": {
                      "type": "integer"
                    },
                    "documents": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "documentId": {
                            "type": "string"
                          },
                          "score": {
                            "type": "number"
                          },
                          "content": {
                            "type": "string"
                          },
                          "kb_entity_type": {
                            "type": "string"
                          },
                          "kb_entity_name": {
                            "type": "string"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - query is required"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/knowledge_processor/knowledge/hybrid_search": {
      "post": {
        "tags": [
          "Knowledge Processor"
        ],
        "summary": "Hybrid search with vector + BM25 fusion and reranking",
        "description": "Combines vector similarity search and BM25 full-text search using Reciprocal Rank Fusion, then reranks results using Cloudflare AI reranker (@cf/baai/bge-reranker-base). Only query is required, all other parameters have defaults.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "query"
                ],
                "properties": {
                  "query": {
                    "type": "string",
                    "description": "Search query text (required)"
                  },
                  "knowledgebase_id": {
                    "type": "string",
                    "description": "Knowledge base ID to search (e.g., \"pt_humanizeiq_service_match_assistant\"). If provided, searches only this knowledgebase."
                  },
                  "kb_owner_type": {
                    "type": "string",
                    "enum": [
                      "User",
                      "Company",
                      "Both"
                    ],
                    "default": "Both",
                    "description": "Filter by owner type. \"Both\" searches User and Company namespaces in parallel."
                  },
                  "limit": {
                    "type": "integer",
                    "default": 10,
                    "description": "Maximum number of results to return"
                  },
                  "rerank": {
                    "type": "boolean",
                    "default": true,
                    "description": "Whether to rerank results using Cloudflare AI"
                  },
                  "vector_top_k": {
                    "type": "integer",
                    "default": 20,
                    "description": "Number of vector search results to retrieve before fusion"
                  },
                  "bm25_top_k": {
                    "type": "integer",
                    "default": 20,
                    "description": "Number of BM25 search results to retrieve before fusion"
                  },
                  "workspace_id": {
                    "type": "string",
                    "description": "Optional workspace ID to filter results"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Hybrid search results",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "query": {
                      "type": "string"
                    },
                    "count": {
                      "type": "integer"
                    },
                    "search_type": {
                      "type": "string",
                      "example": "hybrid"
                    },
                    "kb_owner_type": {
                      "type": "string",
                      "example": "Both"
                    },
                    "reranked": {
                      "type": "boolean"
                    },
                    "documents": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "documentId": {
                            "type": "string"
                          },
                          "rrf_score": {
                            "type": "number",
                            "description": "Reciprocal Rank Fusion score"
                          },
                          "rerank_score": {
                            "type": "number",
                            "description": "Cloudflare AI reranker score"
                          },
                          "text": {
                            "type": "string"
                          },
                          "filename": {
                            "type": "string"
                          },
                          "r2_file_id": {
                            "type": "string"
                          },
                          "chunk_sequence": {
                            "type": "integer"
                          },
                          "kb_entity_type": {
                            "type": "string"
                          },
                          "kb_entity_name": {
                            "type": "string"
                          },
                          "kb_owner_type": {
                            "type": "string"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - query is required"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/knowledge_processor/knowledge/hybrid_semantic_search": {
      "post": {
        "tags": [
          "Knowledge Processor"
        ],
        "summary": "Hybrid semantic search with LLM-generated answer",
        "description": "Performs hybrid search (vector + BM25 + reranking), then passes results to a configured LLM to generate a synthesized answer with source citations. Only query is required, all other parameters have defaults.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "query"
                ],
                "properties": {
                  "query": {
                    "type": "string",
                    "description": "Question or search query (required)"
                  },
                  "knowledgebase_id": {
                    "type": "string",
                    "description": "Knowledge base ID to search (e.g., \"pt_humanizeiq_service_match_assistant\"). If provided, searches only this knowledgebase. Otherwise uses kb_owner_type filtering."
                  },
                  "kb_owner_type": {
                    "type": "string",
                    "enum": [
                      "User",
                      "Company",
                      "Both"
                    ],
                    "default": "Both",
                    "description": "Filter by owner type. \"Both\" searches User and Company namespaces in parallel."
                  },
                  "limit": {
                    "type": "integer",
                    "default": 5,
                    "description": "Number of source documents to use for answer generation"
                  },
                  "rerank": {
                    "type": "boolean",
                    "default": true,
                    "description": "Whether to rerank results using Cloudflare AI"
                  },
                  "vector_top_k": {
                    "type": "integer",
                    "default": 20,
                    "description": "Number of vector search results to retrieve before fusion"
                  },
                  "bm25_top_k": {
                    "type": "integer",
                    "default": 20,
                    "description": "Number of BM25 search results to retrieve before fusion"
                  },
                  "system_prompt": {
                    "type": "string",
                    "description": "Optional custom system prompt for the LLM"
                  },
                  "max_tokens": {
                    "type": "integer",
                    "default": 1024,
                    "description": "Maximum tokens for LLM response"
                  },
                  "workspace_id": {
                    "type": "string",
                    "description": "Optional workspace ID to filter results to specific workspace knowledge documents"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Semantic search result with LLM-generated answer",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "query": {
                      "type": "string"
                    },
                    "answer": {
                      "type": "string",
                      "description": "LLM-generated answer based on search results"
                    },
                    "search_type": {
                      "type": "string",
                      "example": "hybrid_semantic"
                    },
                    "model": {
                      "type": "string",
                      "description": "LLM model used for answer generation"
                    },
                    "sources": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "documentId": {
                            "type": "string"
                          },
                          "filename": {
                            "type": "string"
                          },
                          "r2_file_id": {
                            "type": "string"
                          },
                          "relevance_score": {
                            "type": "number"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - query is required"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/knowledge_processor/knowledge/hybrid_search_light": {
      "post": {
        "tags": [
          "Knowledge Processor"
        ],
        "summary": "Hybrid search with flexible authentication",
        "description": "Hybrid search (vector + BM25 + reranking) with flexible authentication. Supports multiple auth methods with priority order. Always searches Company-level knowledge with optional department filtering. Authentication priority: 1) auth cookie/X-Studio-Cookie, 2) light cookie, 3) X-light query parameter.",
        "security": [
          {
            "ApiKeyAuth": []
          },
          {
            "BearerAuth": []
          },
          {
            "CookieAuth": []
          },
          {
            "StudioCookieAuth": []
          },
          {
            "lightCookie": []
          }
        ],
        "parameters": [
          {
            "name": "X-light",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "description": "Base64-encoded JSON with company_name (lowest priority auth method)"
            },
            "description": "Alternative authentication via query parameter. Base64-encoded JSON containing company_name. This is the lowest priority auth method."
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "query"
                ],
                "properties": {
                  "query": {
                    "type": "string",
                    "description": "Search query text (required)"
                  },
                  "knowledgebase_id": {
                    "type": "string",
                    "description": "Knowledge base ID to search (e.g., \"pt_humanizeiq_service_match_assistant\"). If provided, searches only this knowledgebase. Otherwise uses kb_department filtering."
                  },
                  "kb_department": {
                    "type": "string",
                    "description": "Department name to filter knowledge (used to suffix namespace)"
                  },
                  "limit": {
                    "type": "integer",
                    "default": 10,
                    "description": "Maximum number of results to return"
                  },
                  "rerank": {
                    "type": "boolean",
                    "description": "Whether to rerank results using Cloudflare AI"
                  },
                  "vector_top_k": {
                    "type": "integer",
                    "default": 20,
                    "description": "Number of vector search results to retrieve before fusion"
                  },
                  "bm25_top_k": {
                    "type": "integer",
                    "default": 20,
                    "description": "Number of BM25 search results to retrieve before fusion"
                  },
                  "workspace_id": {
                    "type": "string",
                    "description": "Optional workspace ID to filter results"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Hybrid search results",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "query": {
                      "type": "string"
                    },
                    "count": {
                      "type": "integer"
                    },
                    "search_type": {
                      "type": "string",
                      "example": "hybrid"
                    },
                    "kb_owner_type": {
                      "type": "string",
                      "example": "Company"
                    },
                    "reranked": {
                      "type": "boolean"
                    },
                    "documents": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "documentId": {
                            "type": "string"
                          },
                          "rrf_score": {
                            "type": "number"
                          },
                          "rerank_score": {
                            "type": "number"
                          },
                          "text": {
                            "type": "string"
                          },
                          "filename": {
                            "type": "string"
                          },
                          "r2_file_id": {
                            "type": "string"
                          },
                          "kb_entity_type": {
                            "type": "string"
                          },
                          "kb_entity_name": {
                            "type": "string"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - query is required"
          },
          "401": {
            "description": "Unauthorized - light cookie required or invalid"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/knowledge_processor/knowledge/hybrid_semantic_search_light": {
      "post": {
        "tags": [
          "Knowledge Processor"
        ],
        "summary": "Hybrid semantic search with flexible authentication",
        "description": "Performs hybrid search with LLM answer generation. Supports multiple authentication methods: auth cookie, X-Studio-Cookie, light cookie, or X-light query parameter. Accepts knowledgebase_id for direct namespace search. Only query is required.",
        "security": [
          {
            "ApiKeyAuth": []
          },
          {
            "BearerAuth": []
          },
          {
            "CookieAuth": []
          },
          {
            "StudioCookieAuth": []
          },
          {
            "lightCookie": []
          }
        ],
        "parameters": [
          {
            "name": "X-light",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "description": "Base64-encoded JSON with company_name (lowest priority auth method)"
            },
            "description": "Alternative authentication via query parameter. Base64-encoded JSON containing company_name. This is the lowest priority auth method."
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "query"
                ],
                "properties": {
                  "query": {
                    "type": "string",
                    "description": "Question or search query (required)"
                  },
                  "knowledgebase_id": {
                    "type": "string",
                    "description": "Knowledge base ID to search (e.g., \"pt_humanizeiq_service_match_assistant\"). If provided, searches only this knowledgebase. Otherwise uses kb_department filtering."
                  },
                  "kb_department": {
                    "type": "string",
                    "description": "Department name to filter knowledge (used to suffix namespace)"
                  },
                  "limit": {
                    "type": "integer",
                    "default": 5,
                    "description": "Number of source documents to use for answer generation"
                  },
                  "rerank": {
                    "type": "boolean",
                    "description": "Whether to rerank results using Cloudflare AI"
                  },
                  "vector_top_k": {
                    "type": "integer",
                    "default": 20,
                    "description": "Number of vector search results to retrieve before fusion"
                  },
                  "bm25_top_k": {
                    "type": "integer",
                    "default": 20,
                    "description": "Number of BM25 search results to retrieve before fusion"
                  },
                  "system_prompt": {
                    "type": "string",
                    "description": "Optional custom system prompt for the LLM"
                  },
                  "max_tokens": {
                    "type": "integer",
                    "default": 1024,
                    "description": "Maximum tokens for LLM response"
                  },
                  "workspace_id": {
                    "type": "string",
                    "description": "Optional workspace ID to filter results"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Semantic search result with LLM-generated answer",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "query": {
                      "type": "string"
                    },
                    "answer": {
                      "type": "string",
                      "description": "LLM-generated answer based on search results"
                    },
                    "search_type": {
                      "type": "string",
                      "example": "hybrid_semantic"
                    },
                    "model": {
                      "type": "string",
                      "description": "LLM model used for answer generation"
                    },
                    "sources": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "documentId": {
                            "type": "string"
                          },
                          "filename": {
                            "type": "string"
                          },
                          "r2_file_id": {
                            "type": "string"
                          },
                          "relevance_score": {
                            "type": "number"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - query is required"
          },
          "401": {
            "description": "Unauthorized - light cookie required or invalid"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/knowledge_processor/knowledge/semantic_smart_search_light": {
      "post": {
        "tags": [
          "Knowledge Processor"
        ],
        "summary": "Smart semantic search with LLM tool calling and flexible authentication",
        "description": "LLM-powered search with tool calling capability. The LLM decides when to call the knowledge base search tool. Accepts knowledgebase_id for direct namespace search. Supports multiple authentication methods. Only query is required.",
        "security": [
          {
            "ApiKeyAuth": []
          },
          {
            "BearerAuth": []
          },
          {
            "CookieAuth": []
          },
          {
            "StudioCookieAuth": []
          },
          {
            "lightCookie": []
          }
        ],
        "parameters": [
          {
            "name": "X-light",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "description": "Base64-encoded JSON with company_name (lowest priority auth method)"
            },
            "description": "Alternative authentication via query parameter. Base64-encoded JSON containing company_name. This is the lowest priority auth method."
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "query"
                ],
                "properties": {
                  "query": {
                    "type": "string",
                    "description": "User question or message (required). Can be a greeting, question, or request for information."
                  },
                  "knowledgebase_id": {
                    "type": "string",
                    "description": "Knowledge base ID to search (e.g., \"pt_humanizeiq_service_match_assistant\"). If provided, searches only this knowledgebase. Otherwise uses kb_department filtering."
                  },
                  "kb_department": {
                    "type": "string",
                    "description": "Department name to filter knowledge (used to suffix namespace)"
                  },
                  "system_prompt": {
                    "type": "string",
                    "description": "Optional custom system prompt for the LLM. Default: \"You are Aura company's helpful knowledge base assistant...\""
                  },
                  "max_tokens": {
                    "type": "integer",
                    "default": 2048,
                    "description": "Maximum tokens for LLM response"
                  },
                  "workspace_id": {
                    "type": "string",
                    "description": "Optional workspace ID to filter results"
                  },
                  "history": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "role": {
                          "type": "string",
                          "enum": [
                            "user",
                            "assistant",
                            "system"
                          ]
                        },
                        "content": {
                          "type": "string"
                        }
                      },
                      "required": [
                        "role",
                        "content"
                      ]
                    },
                    "description": "Conversation history for context-aware answers"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Smart semantic search completed with LLM-generated answer",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "query": {
                      "type": "string"
                    },
                    "answer": {
                      "type": "string",
                      "description": "LLM-generated answer based on retrieved context or direct response"
                    },
                    "sources": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "documentId": {
                            "type": "string"
                          },
                          "filename": {
                            "type": "string"
                          },
                          "r2_file_id": {
                            "type": "string"
                          },
                          "relevance_score": {
                            "type": "number"
                          }
                        }
                      },
                      "description": "Source documents used (empty if LLM responded without search)"
                    },
                    "search_type": {
                      "type": "string",
                      "enum": [
                        "smart_semantic"
                      ],
                      "description": "Type of search performed"
                    },
                    "model": {
                      "type": "string",
                      "description": "LLM model used"
                    },
                    "tool_calls_made": {
                      "type": "integer",
                      "description": "Number of times the LLM called the search tool"
                    },
                    "max_iterations_reached": {
                      "type": "boolean",
                      "description": "Whether the maximum tool call iterations was reached"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - query is required"
          },
          "401": {
            "description": "Unauthorized - authentication required"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/knowledge_processor/knowledge/semantic_smart_search": {
      "post": {
        "tags": [
          "Knowledge Processor"
        ],
        "summary": "Smart semantic search with LLM tool calling and flexible authentication (Standard Endpoint)",
        "description": "Standard endpoint for smart semantic search. LLM-powered search with tool calling capability. The LLM decides when to call the knowledge base search tool. Accepts knowledgebase_id for direct namespace search. Supports multiple authentication methods. Only query is required.",
        "security": [
          {
            "CookieAuth": []
          },
          {
            "StudioCookieAuth": []
          },
          {
            "lightCookie": []
          }
        ],
        "parameters": [
          {
            "name": "X-light",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "description": "Base64-encoded JSON with company_name (lowest priority auth method)"
            },
            "description": "Alternative authentication via query parameter. Base64-encoded JSON containing company_name. This is the lowest priority auth method."
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "query"
                ],
                "properties": {
                  "query": {
                    "type": "string",
                    "description": "User question or message (required). Can be a greeting, question, or request for information."
                  },
                  "knowledgebase_id": {
                    "type": "string",
                    "description": "Knowledge base ID to search (e.g., \"pt_humanizeiq_service_match_assistant\"). If provided, searches only this knowledgebase. Otherwise uses kb_department filtering."
                  },
                  "kb_department": {
                    "type": "string",
                    "description": "Department name to filter knowledge (used to suffix namespace)"
                  },
                  "system_prompt": {
                    "type": "string",
                    "description": "Optional custom system prompt for the LLM. Default: \"You are Aura company's helpful knowledge base assistant...\""
                  },
                  "max_tokens": {
                    "type": "integer",
                    "default": 2048,
                    "description": "Maximum tokens for LLM response"
                  },
                  "workspace_id": {
                    "type": "string",
                    "description": "Optional workspace ID to filter results"
                  },
                  "history": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "role": {
                          "type": "string",
                          "enum": [
                            "user",
                            "assistant",
                            "system"
                          ]
                        },
                        "content": {
                          "type": "string"
                        }
                      },
                      "required": [
                        "role",
                        "content"
                      ]
                    },
                    "description": "Conversation history for context-aware answers"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Smart semantic search completed with LLM-generated answer",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "query": {
                      "type": "string"
                    },
                    "answer": {
                      "type": "string",
                      "description": "LLM-generated answer based on retrieved context or direct response"
                    },
                    "sources": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "documentId": {
                            "type": "string"
                          },
                          "filename": {
                            "type": "string"
                          },
                          "r2_file_id": {
                            "type": "string"
                          },
                          "relevance_score": {
                            "type": "number"
                          }
                        }
                      },
                      "description": "Source documents used (empty if LLM responded without search)"
                    },
                    "search_type": {
                      "type": "string",
                      "enum": [
                        "smart_semantic"
                      ],
                      "description": "Type of search performed"
                    },
                    "model": {
                      "type": "string",
                      "description": "LLM model used"
                    },
                    "tool_calls_made": {
                      "type": "integer",
                      "description": "Number of times the LLM called the search tool"
                    },
                    "max_iterations_reached": {
                      "type": "boolean",
                      "description": "Whether the maximum tool call iterations was reached"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - query is required"
          },
          "401": {
            "description": "Unauthorized - authentication required"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/knowledge_processor/namespaces": {
      "get": {
        "tags": [
          "Knowledge Processor"
        ],
        "summary": "Get Turbopuffer namespace structure information",
        "description": "Returns information about how Turbopuffer namespaces are structured. Note: The v1 /namespaces endpoint requires special API key permissions, so this endpoint provides structure information instead.",
        "responses": {
          "200": {
            "description": "Namespace structure information",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "message": {
                      "type": "string",
                      "example": "Namespace structure information. Note: Listing all namespaces requires special API key permissions for the v1 endpoint."
                    },
                    "namespace_structure": {
                      "type": "object",
                      "properties": {
                        "company_level": {
                          "type": "string",
                          "example": "nonprod_<company_name> (optional: _<department>)"
                        },
                        "user_level": {
                          "type": "string",
                          "example": "nonprod_<company_name>_<uid> (optional: _<department>)"
                        },
                        "examples": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          },
                          "example": [
                            "nonprod_humanizeiq",
                            "nonprod_humanizeiq_recruiting",
                            "nonprod_humanizeiq_user123"
                          ]
                        }
                      }
                    },
                    "notes": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "example": [
                        "All namespace names are lowercase",
                        "Namespaces are created implicitly when documents are first uploaded",
                        "To check if a specific namespace exists, query it directly using the search endpoints"
                      ]
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Auth cookie required"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/knowledge_processor/namespace": {
      "delete": {
        "tags": [
          "Knowledge Processor"
        ],
        "summary": "Delete a Turbopuffer namespace (knowledge base)",
        "description": "Permanently deletes a Turbopuffer namespace and all its data by namespace name. The namespace name will be converted to lowercase automatically.",
        "parameters": [
          {
            "name": "namespace",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string",
              "example": "nonprod_humanizeiq_recruiting"
            },
            "description": "The namespace name to delete (will be converted to lowercase)"
          }
        ],
        "responses": {
          "200": {
            "description": "Namespace deleted successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "message": {
                      "type": "string"
                    },
                    "namespace": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Auth cookie required"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/knowledgebase": {
      "post": {
        "tags": [
          "Knowledge Base"
        ],
        "summary": "Create a new knowledge base definition",
        "description": "Creates a knowledge base entry in the database. The name and R2 bucket base path are automatically calculated using current naming rules based on type, company, user, and department.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "type",
                  "access_level"
                ],
                "properties": {
                  "id": {
                    "type": "string",
                    "description": "Optional custom ID for the knowledge base. If not provided, will be auto-generated.",
                    "example": "kb_1768238840696"
                  },
                  "title": {
                    "type": "string",
                    "description": "Display title for the knowledge base",
                    "example": "Human Resources"
                  },
                  "description": {
                    "type": "string",
                    "description": "Description of the knowledge base",
                    "example": "Human Resources knowledge base"
                  },
                  "slug": {
                    "type": "string",
                    "description": "URL-friendly slug for the knowledge base",
                    "example": "human_resources"
                  },
                  "roles": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "description": "List of roles that have access to this knowledge base",
                    "example": [
                      "Executive",
                      "Manager",
                      "Employee"
                    ]
                  },
                  "system_prompt": {
                    "type": "string",
                    "description": "Custom system prompt for this knowledge base",
                    "example": "You are a helpful HR assistant. Use the knowledge base to answer questions about company policies."
                  },
                  "type": {
                    "type": "string",
                    "enum": [
                      "User",
                      "Company"
                    ],
                    "description": "Knowledge base type - User-level or Company-level"
                  },
                  "department": {
                    "type": "string",
                    "description": "Department name (optional). If provided, will be included in the namespace and path.",
                    "example": "Recruiting"
                  },
                  "access_level": {
                    "type": "string",
                    "enum": [
                      "Personal",
                      "Company",
                      "Department",
                      "Anonymous"
                    ],
                    "description": "Access level for the knowledge base"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Knowledge base created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "message": {
                      "type": "string"
                    },
                    "knowledgebase": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string",
                          "description": "Knowledge base ID",
                          "example": "kb_1768238840696"
                        },
                        "name": {
                          "type": "string",
                          "description": "Calculated namespace name (lowercase)",
                          "example": "nonprod_humanizeiq_recruiting"
                        },
                        "title": {
                          "type": "string",
                          "description": "Display title",
                          "example": "Human Resources"
                        },
                        "description": {
                          "type": "string",
                          "description": "Description",
                          "example": "Human Resources knowledge base"
                        },
                        "slug": {
                          "type": "string",
                          "description": "URL-friendly slug",
                          "example": "human_resources"
                        },
                        "roles": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          },
                          "description": "List of roles",
                          "example": [
                            "Executive",
                            "Manager"
                          ]
                        },
                        "system_prompt": {
                          "type": "string",
                          "description": "Custom system prompt",
                          "example": "You are a helpful assistant."
                        },
                        "type": {
                          "type": "string",
                          "example": "Company"
                        },
                        "department": {
                          "type": "string",
                          "example": "Recruiting"
                        },
                        "r2_bucket_base_path": {
                          "type": "string",
                          "description": "Calculated R2 base path",
                          "example": "HumanizeIQ/departments/Recruiting/"
                        },
                        "access_level": {
                          "type": "string",
                          "example": "Department"
                        },
                        "company_name": {
                          "type": "string",
                          "example": "HumanizeIQ"
                        },
                        "uid": {
                          "type": "string",
                          "description": "User ID (null for Company type)"
                        },
                        "created_by": {
                          "type": "string",
                          "description": "Email of creator"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - missing required fields or auth cookie"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/knowledgebase/{id}": {
      "get": {
        "tags": [
          "Knowledge Base"
        ],
        "summary": "Get knowledge base by ID",
        "description": "Retrieves a knowledge base definition by its ID.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Knowledge base ID",
            "example": "nonprod_humanizeiq_recruiting"
          }
        ],
        "responses": {
          "200": {
            "description": "Knowledge base retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "knowledgebase": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        },
                        "title": {
                          "type": "string"
                        },
                        "description": {
                          "type": "string"
                        },
                        "slug": {
                          "type": "string"
                        },
                        "roles": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "system_prompt": {
                          "type": "string"
                        },
                        "type": {
                          "type": "string"
                        },
                        "department": {
                          "type": "string"
                        },
                        "r2_bucket_base_path": {
                          "type": "string"
                        },
                        "access_level": {
                          "type": "string"
                        },
                        "company_name": {
                          "type": "string"
                        },
                        "uid": {
                          "type": "string"
                        },
                        "created_by": {
                          "type": "string"
                        },
                        "created_at": {
                          "type": "string"
                        },
                        "updated_at": {
                          "type": "string"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Auth cookie required"
          },
          "404": {
            "description": "Knowledge base not found"
          },
          "500": {
            "description": "Server error"
          }
        }
      },
      "patch": {
        "tags": [
          "Knowledge Base"
        ],
        "summary": "Update knowledge base by ID",
        "description": "Updates a knowledge base definition. Only provided fields will be updated.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Knowledge base ID",
            "example": "nonprod_humanizeiq_recruiting"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "title": {
                    "type": "string",
                    "description": "Display title for the knowledge base",
                    "example": "Human Resources"
                  },
                  "description": {
                    "type": "string",
                    "description": "Description of the knowledge base",
                    "example": "Human Resources knowledge base"
                  },
                  "slug": {
                    "type": "string",
                    "description": "URL-friendly slug for the knowledge base",
                    "example": "human_resources"
                  },
                  "roles": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "description": "List of roles that have access to this knowledge base",
                    "example": [
                      "Executive",
                      "Manager",
                      "Employee"
                    ]
                  },
                  "system_prompt": {
                    "type": "string",
                    "description": "Custom system prompt for this knowledge base",
                    "example": "You are a helpful HR assistant."
                  },
                  "department": {
                    "type": "string",
                    "description": "Department name",
                    "example": "Recruiting"
                  },
                  "access_level": {
                    "type": "string",
                    "enum": [
                      "Personal",
                      "Company",
                      "Department",
                      "Anonymous"
                    ],
                    "description": "Access level for the knowledge base"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Knowledge base updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "message": {
                      "type": "string"
                    },
                    "knowledgebase": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        },
                        "title": {
                          "type": "string"
                        },
                        "description": {
                          "type": "string"
                        },
                        "slug": {
                          "type": "string"
                        },
                        "roles": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          }
                        },
                        "system_prompt": {
                          "type": "string"
                        },
                        "type": {
                          "type": "string"
                        },
                        "department": {
                          "type": "string"
                        },
                        "r2_bucket_base_path": {
                          "type": "string"
                        },
                        "access_level": {
                          "type": "string"
                        },
                        "company_name": {
                          "type": "string"
                        },
                        "uid": {
                          "type": "string"
                        },
                        "created_by": {
                          "type": "string"
                        },
                        "created_at": {
                          "type": "string"
                        },
                        "updated_at": {
                          "type": "string"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Auth cookie required or no valid fields to update"
          },
          "404": {
            "description": "Knowledge base not found"
          },
          "500": {
            "description": "Server error"
          }
        }
      },
      "delete": {
        "tags": [
          "Knowledge Base"
        ],
        "summary": "Delete knowledge base by ID",
        "description": "Deletes a knowledge base definition from the database. Note: This only deletes the database entry, not the actual Turbopuffer namespace or R2 files.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Knowledge base ID",
            "example": "nonprod_humanizeiq_recruiting"
          }
        ],
        "responses": {
          "200": {
            "description": "Knowledge base deleted successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "message": {
                      "type": "string"
                    },
                    "id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Auth cookie required"
          },
          "404": {
            "description": "Knowledge base not found"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/knowledgebase/{id}/documents": {
      "post": {
        "tags": [
          "Knowledge Base"
        ],
        "summary": "Upload document to knowledge base",
        "description": "Uploads a document to a specific knowledge base. The document is stored in R2, metadata is saved to knowledge_data table, and the document is queued for vector processing.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Knowledge base ID",
            "example": "nonprod_humanizeiq_hr"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "required": [
                  "file",
                  "metadata"
                ],
                "properties": {
                  "file": {
                    "type": "string",
                    "format": "binary",
                    "description": "Document file to upload"
                  },
                  "metadata": {
                    "type": "string",
                    "description": "JSON string containing document metadata",
                    "example": "{\"kb_entity_type\":\"Policy\",\"kb_entity_name\":\"Employee Handbook\",\"kb_version\":\"1.0\",\"kb_updated_utc\":\"2026-01-21T12:00:00Z\",\"kb_owner_type\":\"Company\",\"workspace_id\":\"ws_123\",\"kb_sources\":\"manual_upload\"}"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Document uploaded successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "fileId": {
                      "type": "string",
                      "description": "Encoded file ID"
                    },
                    "path": {
                      "type": "string",
                      "description": "R2 storage path"
                    },
                    "knowledgebase_id": {
                      "type": "string"
                    },
                    "category": {
                      "type": "string"
                    },
                    "indexing_status": {
                      "type": "string",
                      "example": "pending"
                    },
                    "metadata": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Auth cookie required or invalid request"
          },
          "404": {
            "description": "Knowledge base not found"
          },
          "500": {
            "description": "Server error"
          }
        }
      },
      "get": {
        "tags": [
          "Knowledge Base"
        ],
        "summary": "List documents in a knowledge base",
        "description": "Returns all documents stored in a specific knowledge base from the knowledge_data table.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Knowledge base ID",
            "example": "nonprod_humanizeiq_hr"
          }
        ],
        "responses": {
          "200": {
            "description": "Documents retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "knowledgebase": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        },
                        "title": {
                          "type": "string"
                        }
                      }
                    },
                    "count": {
                      "type": "integer"
                    },
                    "documents": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string"
                          },
                          "knowledgebase_id": {
                            "type": "string"
                          },
                          "filename": {
                            "type": "string"
                          },
                          "r2_file_path": {
                            "type": "string"
                          },
                          "entity_name": {
                            "type": "string"
                          },
                          "entity_type": {
                            "type": "string"
                          },
                          "workspace_id": {
                            "type": "string"
                          },
                          "kb_version": {
                            "type": "string"
                          },
                          "kb_updated_utc": {
                            "type": "string"
                          },
                          "kb_owner_type": {
                            "type": "string"
                          },
                          "kb_sources": {
                            "type": "string"
                          },
                          "indexing_status": {
                            "type": "string"
                          },
                          "created_at": {
                            "type": "string"
                          },
                          "updated_at": {
                            "type": "string"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Auth cookie required"
          },
          "404": {
            "description": "Knowledge base not found"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/knowledgebase/{id}/documents/{documentId}": {
      "get": {
        "tags": [
          "Knowledge Base"
        ],
        "summary": "Get a single document from knowledge base",
        "description": "Retrieves metadata for a specific document. All files are stored as JSON in R2: text files use \"content\" field, binary files (PDF, Word, etc.) use \"binary_data\" field with base64-encoded content. With binary=true, decodes and downloads the binary file. With include_content=true, includes text content in JSON response. Database stores NO content, only metadata.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Knowledge base ID",
            "example": "nonprod_humanizeiq_hr"
          },
          {
            "name": "documentId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Document ID (base64 encoded R2 path)",
            "example": "SHVtYW5pemVJUS9kZXBhcnRtZW50cy9teV93b3Jrc3BhY2UvNzkzOWNmZTEtYzZiNC00Y2ZhLTg2OTEtYWRhNzdmMDExNTUzL090aGVyL1Rlc3RfRG9jdW1lbnRfMTc2OTAyNDA1NzE1MS5qc29u"
          },
          {
            "name": "binary",
            "in": "query",
            "required": false,
            "schema": {
              "type": "boolean",
              "default": false
            },
            "description": "If true and document is binary (PDF, Word, etc.), returns the file as a downloadable binary with Content-Disposition header. Ignored for text files."
          },
          {
            "name": "include_content",
            "in": "query",
            "required": false,
            "schema": {
              "type": "boolean",
              "default": false
            },
            "description": "If true and document is text, includes the text content in JSON response. Ignored for binary files."
          }
        ],
        "responses": {
          "200": {
            "description": "Document retrieved successfully. Returns JSON metadata by default, or binary file download if binary=true.",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "knowledgebase": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        },
                        "title": {
                          "type": "string"
                        }
                      }
                    },
                    "document": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "knowledgebase_id": {
                          "type": "string"
                        },
                        "filename": {
                          "type": "string"
                        },
                        "r2_file_path": {
                          "type": "string"
                        },
                        "entity_name": {
                          "type": "string"
                        },
                        "entity_type": {
                          "type": "string"
                        },
                        "workspace_id": {
                          "type": "string"
                        },
                        "kb_version": {
                          "type": "string"
                        },
                        "kb_updated_utc": {
                          "type": "string"
                        },
                        "kb_owner_type": {
                          "type": "string"
                        },
                        "kb_sources": {
                          "type": "string"
                        },
                        "indexing_status": {
                          "type": "string",
                          "enum": [
                            "pending",
                            "indexing",
                            "completed",
                            "failed"
                          ]
                        },
                        "binary_data": {
                          "type": "string",
                          "description": "JSON string with metadata for binary files: {\"content_type\": \"application/pdf\", \"size\": 12345}. Null for text files. Actual binary content is base64-encoded in R2 JSON file, not in database."
                        },
                        "created_at": {
                          "type": "string"
                        },
                        "updated_at": {
                          "type": "string"
                        }
                      }
                    },
                    "content": {
                      "type": "string",
                      "description": "Text document content (only if include_content=true and binary_data is null)"
                    },
                    "content_error": {
                      "type": "string",
                      "description": "Error message if content fetch failed"
                    }
                  }
                }
              },
              "application/pdf": {
                "schema": {
                  "type": "string",
                  "format": "binary",
                  "description": "Binary file download (when binary=true and is_binary=1). Response includes Content-Disposition: attachment header."
                }
              },
              "application/octet-stream": {
                "schema": {
                  "type": "string",
                  "format": "binary",
                  "description": "Binary file download for other file types (Word, Excel, etc.)"
                }
              }
            }
          },
          "400": {
            "description": "Auth cookie required"
          },
          "404": {
            "description": "Knowledge base or document not found"
          },
          "500": {
            "description": "Server error"
          }
        }
      },
      "delete": {
        "tags": [
          "Knowledge Base"
        ],
        "summary": "Delete document from knowledge base",
        "description": "Deletes a document from a knowledge base. The document is removed from R2 storage, deleted from knowledge_data table, and queued for Turbopuffer cleanup.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Knowledge base ID",
            "example": "nonprod_humanizeiq_hr"
          },
          {
            "name": "documentId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Document ID (fileId)",
            "example": "encoded_file_id_123"
          }
        ],
        "responses": {
          "200": {
            "description": "Document deleted successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "fileId": {
                      "type": "string",
                      "description": "Document ID"
                    },
                    "knowledgebase_id": {
                      "type": "string"
                    },
                    "message": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Auth cookie required"
          },
          "404": {
            "description": "Knowledge base or document not found"
          },
          "500": {
            "description": "Server error"
          }
        }
      },
      "patch": {
        "tags": [
          "Knowledge Base"
        ],
        "summary": "Update document in knowledge base",
        "description": "Updates an existing document in a knowledge base. The document is updated in R2, metadata is updated in knowledge_data table, and the document is queued for re-processing.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Knowledge base ID",
            "example": "nonprod_humanizeiq_hr"
          },
          {
            "name": "documentId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Document ID (fileId)",
            "example": "encoded_file_id_123"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "required": [
                  "file",
                  "metadata"
                ],
                "properties": {
                  "file": {
                    "type": "string",
                    "format": "binary",
                    "description": "Updated document file"
                  },
                  "metadata": {
                    "type": "string",
                    "description": "JSON string containing updated document metadata",
                    "example": "{\"kb_entity_type\":\"Policy\",\"kb_entity_name\":\"Employee Handbook\",\"kb_version\":\"2.0\",\"kb_updated_utc\":\"2026-01-21T14:00:00Z\",\"kb_owner_type\":\"Company\",\"workspace_id\":\"ws_123\",\"kb_sources\":\"manual_update\"}"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Document updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "fileId": {
                      "type": "string",
                      "description": "Document ID"
                    },
                    "path": {
                      "type": "string",
                      "description": "R2 storage path"
                    },
                    "knowledgebase_id": {
                      "type": "string"
                    },
                    "category": {
                      "type": "string"
                    },
                    "indexing_status": {
                      "type": "string",
                      "example": "pending"
                    },
                    "metadata": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Auth cookie required or invalid request"
          },
          "404": {
            "description": "Knowledge base or document not found"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/knowledgebase/{id}/reindex": {
      "post": {
        "tags": [
          "Knowledge Base"
        ],
        "summary": "Reindex all documents in knowledge base",
        "description": "Queues all documents in a knowledge base for reprocessing. Sets all documents to pending status and sends them to the processing queue with Update action.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Knowledge base ID",
            "example": "nonprod_humanizeiq_hr"
          }
        ],
        "responses": {
          "200": {
            "description": "Reindexing initiated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "knowledgebase_id": {
                      "type": "string"
                    },
                    "knowledgebase_name": {
                      "type": "string"
                    },
                    "knowledgebase_title": {
                      "type": "string"
                    },
                    "total_documents": {
                      "type": "integer",
                      "description": "Total number of documents in knowledgebase"
                    },
                    "documents_queued": {
                      "type": "integer",
                      "description": "Number of documents successfully queued"
                    },
                    "failed_documents": {
                      "type": "array",
                      "description": "List of documents that failed to queue (if any)",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string"
                          },
                          "filename": {
                            "type": "string"
                          },
                          "error": {
                            "type": "string"
                          }
                        }
                      }
                    },
                    "message": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Auth cookie required"
          },
          "404": {
            "description": "Knowledge base not found"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/jobs/{jobId}/update": {
      "post": {
        "tags": [
          "Knowledge Base"
        ],
        "summary": "Update document with parsed markdown from parser job",
        "description": "Called by the datalab-parser service when a parse job completes. Updates the document content with the parsed markdown and queues it for vector processing. The knowledgebase_id is looked up automatically from the job_id. Requires X-Api-Key authentication.",
        "parameters": [
          {
            "name": "jobId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Parse job ID returned from parser invoke",
            "example": "pf0fYTeKcJEj7siP1-ocTQ"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "markdown"
                ],
                "properties": {
                  "markdown": {
                    "type": "string",
                    "description": "Parsed markdown content from the document",
                    "example": "# Document Title\n\nParsed content here..."
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Document updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "document_id": {
                      "type": "string",
                      "description": "Document ID"
                    },
                    "knowledgebase_id": {
                      "type": "string",
                      "description": "Knowledge base ID"
                    },
                    "job_id": {
                      "type": "string",
                      "description": "Parse job ID"
                    },
                    "message": {
                      "type": "string",
                      "example": "Document updated with markdown and queued for vector processing"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Markdown content is required"
          },
          "404": {
            "description": "Document not found for the given job ID"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/knowledgebases": {
      "get": {
        "tags": [
          "Knowledge Base"
        ],
        "summary": "List knowledge bases for authenticated user",
        "description": "Returns Personal knowledgebases owned by the authenticated user OR Company knowledgebases with the same company as the user. No query parameters required - uses authenticated user data.",
        "responses": {
          "200": {
            "description": "Knowledge bases retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "count": {
                      "type": "integer"
                    },
                    "knowledgebases": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string"
                          },
                          "name": {
                            "type": "string"
                          },
                          "title": {
                            "type": "string"
                          },
                          "description": {
                            "type": "string"
                          },
                          "slug": {
                            "type": "string"
                          },
                          "roles": {
                            "type": "array",
                            "items": {
                              "type": "string"
                            }
                          },
                          "system_prompt": {
                            "type": "string"
                          },
                          "type": {
                            "type": "string"
                          },
                          "department": {
                            "type": "string"
                          },
                          "r2_bucket_base_path": {
                            "type": "string"
                          },
                          "access_level": {
                            "type": "string"
                          },
                          "company_name": {
                            "type": "string"
                          },
                          "uid": {
                            "type": "string"
                          },
                          "created_by": {
                            "type": "string"
                          },
                          "created_at": {
                            "type": "string"
                          },
                          "updated_at": {
                            "type": "string"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Auth cookie required"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/converter/html_to_word": {
      "post": {
        "tags": [
          "Converter"
        ],
        "summary": "Convert HTML file to Word (DOCX) format",
        "description": "Fetches a file from R2 storage by fileId and converts it to Word (DOCX) format. Returns the converted document as a downloadable file.",
        "security": [
          {
            "ApiKeyAuth": []
          },
          {
            "BearerAuth": []
          },
          {
            "CookieAuth": []
          },
          {
            "StudioCookieAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "fileId"
                ],
                "properties": {
                  "fileId": {
                    "type": "string",
                    "description": "R2 file ID to convert",
                    "example": "abc123-def456-ghi789"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successfully converted file to Word format",
            "headers": {
              "Content-Type": {
                "schema": {
                  "type": "string",
                  "example": "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                },
                "description": "MIME type for DOCX files"
              },
              "Content-Disposition": {
                "schema": {
                  "type": "string",
                  "example": "attachment; filename=\"document.docx\""
                },
                "description": "Suggests filename for download"
              },
              "X-Original-File-Id": {
                "schema": {
                  "type": "string"
                },
                "description": "Original R2 file ID"
              },
              "X-Original-File-Name": {
                "schema": {
                  "type": "string"
                },
                "description": "Original filename before conversion"
              }
            },
            "content": {
              "application/vnd.openxmlformats-officedocument.wordprocessingml.document": {
                "schema": {
                  "type": "string",
                  "format": "binary",
                  "description": "DOCX file binary data"
                }
              }
            }
          },
          "400": {
            "description": "Bad request - missing required parameters",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "fileId is required"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - authentication required",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Authentication required"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Internal server error - conversion failed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "Failed to convert file to Word"
                    },
                    "details": {
                      "type": "string",
                      "example": "Failed to fetch file from R2: File not found"
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}